---
// Chat Widget - MasaÃ¼stÃ¼nde gÃ¶sterilir
import { getEntry } from 'astro:content';

const siteEntry = await getEntry('site', 'main');
const { contact, office } = siteEntry.data;
---

<a href={`https://wa.me/${contact.whatsapp}`} class="whatsapp-float" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp ile iletiÅŸime geÃ§">
  <i class="fa-brands fa-whatsapp"></i>
</a>

<div class="chat-widget">
  <div id="chatGreeting" class="chat-greeting">Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim? ğŸ‘‹</div>
  <button id="chatToggle" class="chat-toggle-btn" aria-label="Sohbeti aÃ§">
    <i class="fa-solid fa-comments"></i>
  </button>
  <div id="chatBox" class="chat-box" role="dialog" aria-label="Sohbet penceresi">
    <div class="chat-header">
      <span>Turan Asistan</span>
      <button id="closeChat" aria-label="Sohbeti kapat">&times;</button>
    </div>
    <div id="chatBody" class="chat-body">
      <div class="chat-msg bot">Merhaba, ben Av. Fatih Turan'Ä±n sanal asistanÄ±yÄ±m. Size nasÄ±l yardÄ±mcÄ± olabilirim?</div>
      <div class="chat-options">
        <button data-reply="randevu">Randevu Almak Ä°stiyorum</button>
        <button data-reply="alanlar">Ã‡alÄ±ÅŸma AlanlarÄ±</button>
        <button data-reply="konum">Ofis Nerede?</button>
        <button data-reply="ucret">DanÄ±ÅŸmanlÄ±k Ãœcreti</button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ officeAddress: office.address, officeNote: office.note }}>
  function initChatBot() {
    if (window.innerWidth <= 768) return;

    var chatToggle = document.getElementById('chatToggle');
    var chatBox = document.getElementById('chatBox');
    var closeChat = document.getElementById('closeChat');
    var greeting = document.getElementById('chatGreeting');
    var chatBody = document.getElementById('chatBody');

    if (!chatToggle || !chatBox || !closeChat || !greeting || !chatBody) return;

    var hasSeenGreeting = null;
    try { hasSeenGreeting = localStorage.getItem('chatGreetingShown'); } catch(e) {}

    if (!hasSeenGreeting) {
      setTimeout(function() {
        try { localStorage.setItem('chatGreetingShown', 'true'); } catch(e) {}
        if(chatBox.style.display !== 'flex') greeting.style.display = 'block';
      }, 2500);
      setTimeout(function() { greeting.style.display = 'none'; }, 12000);
    }

    chatToggle.addEventListener('click', function() {
      if (chatBox.style.display === 'flex') {
        chatBox.style.display = 'none';
      } else {
        chatBox.style.display = 'flex';
        greeting.style.display = 'none';
      }
    });

    closeChat.addEventListener('click', function() { chatBox.style.display = 'none'; });

    // Chat reply buttons
    var replies = {
      randevu: {
        user: "Randevu almak istiyorum.",
        bot: "Randevu talebinizi <a href='/iletisim' style='color:#c5a059;font-weight:bold;'>buraya tÄ±klayarak</a> iletebilirsiniz."
      },
      alanlar: {
        user: "Ã‡alÄ±ÅŸma alanlarÄ± nelerdir?",
        bot: "Detaylar iÃ§in <a href='/calisma-alanlari' style='color:#c5a059;font-weight:bold;'>tÄ±klayÄ±nÄ±z.</a>"
      },
      konum: {
        user: "Ofis nerede?",
        bot: "Ofisimiz " + officeAddress + "'dadÄ±r. " + officeNote
      },
      ucret: {
        user: "DanÄ±ÅŸmanlÄ±k Ã¼cretli mi?",
        bot: "Evet, AvukatlÄ±k Kanunu gereÄŸi danÄ±ÅŸmanlÄ±k hizmetleri Ã¼crete tabidir."
      }
    };

    var buttons = chatBody.querySelectorAll('.chat-options button');
    for (var i = 0; i < buttons.length; i++) {
      buttons[i].addEventListener('click', function() {
        var option = this.getAttribute('data-reply');
        if (!option || !replies[option]) return;

        var reply = replies[option];
        var options = chatBody.querySelector('.chat-options');

        var userDiv = document.createElement('div');
        userDiv.className = 'chat-msg user';
        userDiv.innerHTML = reply.user;
        if (options) chatBody.insertBefore(userDiv, options);

        setTimeout(function() {
          var botDiv = document.createElement('div');
          botDiv.className = 'chat-msg bot';
          botDiv.innerHTML = reply.bot;
          if (options) chatBody.insertBefore(botDiv, options);
          chatBody.scrollTop = chatBody.scrollHeight;
        }, 600);
      });
    }
  }

  document.addEventListener('DOMContentLoaded', initChatBot);
  document.addEventListener('astro:after-swap', initChatBot);
</script>
