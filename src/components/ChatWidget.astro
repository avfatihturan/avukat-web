---
// Chat Widget - Masaüstünde gösterilir
import { getEntry } from 'astro:content';

const siteEntry = await getEntry('site', 'main');
const chatbotEntry = await getEntry('chatbot', 'main');

if (!siteEntry || !chatbotEntry) {
  throw new Error("Site veya Chatbot verisi (json) bulunamadı.");
}

const { contact } = siteEntry.data;
const { greeting, welcomeMessage, assistantName, options } = chatbotEntry.data;

const safeOptions = options || [];

const processTemplate = (text: string) => {
  return text
    .replace(/\{\{phone\}\}/g, contact.phone || '')
    .replace(/\{\{phoneLink\}\}/g, contact.phoneLink || '')
    .replace(/\{\{email\}\}/g, contact.email || '')
    .replace(/\{\{whatsapp\}\}/g, contact.whatsapp || '');
};

const processedOptions = safeOptions.map(opt => ({
  ...opt,
  botResponse: processTemplate(opt.botResponse)
}));
---

<a href={`https://wa.me/${contact.whatsapp}`} class="whatsapp-float" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp ile iletişime geç">
  <i class="fa-brands fa-whatsapp"></i>
</a>

<div class="chat-widget">
  <div id="chatGreeting" class="chat-greeting">{greeting}</div>
  <button id="chatToggle" class="chat-toggle-btn" aria-label="Sohbeti aç">
    <i class="fa-solid fa-comments"></i>
  </button>
  <div id="chatBox" class="chat-box" role="dialog" aria-label="Sohbet penceresi">
    <div class="chat-header">
      <span>{assistantName}</span>
      <div class="chat-quick-actions">
        <a href={contact.phoneLink} title="Ara"><i class="fa-solid fa-phone"></i></a>
        <a href={`mailto:${contact.email}`} title="E-posta"><i class="fa-solid fa-envelope"></i></a>
        <a href={`https://wa.me/${contact.whatsapp}`} target="_blank" rel="noopener noreferrer" title="WhatsApp"><i class="fa-brands fa-whatsapp"></i></a>
      </div>
      <button id="closeChat" aria-label="Sohbeti kapat">&times;</button>
    </div>
    <div id="chatBody" class="chat-body">
      <div class="chat-msg bot">{welcomeMessage}</div>
      <div class="chat-options">
        {processedOptions.map((opt) => (
          <button data-reply={opt.key} data-user={opt.userText} data-bot={opt.botResponse}>
            {opt.icon && <i class={`fa-solid ${opt.icon}`}></i>}
            {opt.label}
          </button>
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  function initChatBot() {
    if (window.innerWidth <= 768) return;

    // TypeScript "as HTMLElement" ile zorlanıyor (Hatalar burada çözüldü)
    const chatToggle = document.getElementById('chatToggle') as HTMLElement;
    const chatBox = document.getElementById('chatBox') as HTMLElement;
    const closeChat = document.getElementById('closeChat') as HTMLElement;
    const greeting = document.getElementById('chatGreeting') as HTMLElement;
    const chatBody = document.getElementById('chatBody') as HTMLElement;

    if (!chatToggle || !chatBox || !closeChat || !greeting || !chatBody) return;

    let hasSeenGreeting: string | null = null;
    try { hasSeenGreeting = localStorage.getItem('chatGreetingShown'); } catch(e) {}

    if (!hasSeenGreeting) {
      setTimeout(function() {
        try { localStorage.setItem('chatGreetingShown', 'true'); } catch(e) {}
        if(chatBox.style.display !== 'flex') greeting.style.display = 'block';
      }, 2500);
      setTimeout(function() { greeting.style.display = 'none'; }, 12000);
    }

    chatToggle.addEventListener('click', function() {
      if (chatBox.style.display === 'flex') {
        chatBox.style.display = 'none';
      } else {
        chatBox.style.display = 'flex';
        greeting.style.display = 'none';
      }
    });

    closeChat.addEventListener('click', function() { chatBox.style.display = 'none'; });

    const buttons = chatBody.querySelectorAll('.chat-options button');
    buttons.forEach((btn) => {
      btn.addEventListener('click', function(e) {
        const target = e.currentTarget as HTMLButtonElement;
        const userText = target.getAttribute('data-user');
        const botText = target.getAttribute('data-bot');
        
        if (!userText || !botText) return;

        const options = chatBody.querySelector('.chat-options');

        const userDiv = document.createElement('div');
        userDiv.className = 'chat-msg user';
        userDiv.innerHTML = userText;
        if (options) chatBody.insertBefore(userDiv, options);

        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = '<span></span><span></span><span></span>';
        if (options) chatBody.insertBefore(typingDiv, options);
        chatBody.scrollTop = chatBody.scrollHeight;

        setTimeout(function() {
          typingDiv.remove();
          const botDiv = document.createElement('div');
          botDiv.className = 'chat-msg bot';
          botDiv.innerHTML = botText;
          if (options) chatBody.insertBefore(botDiv, options);
          chatBody.scrollTop = chatBody.scrollHeight;
        }, 800);
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initChatBot);
  document.addEventListener('astro:after-swap', initChatBot);
</script>