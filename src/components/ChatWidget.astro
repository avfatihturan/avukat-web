---
import { getEntry } from 'astro:content';

const siteEntry = await getEntry('site', 'main');
const chatbotEntry = await getEntry('chatbot', 'main');

if (!siteEntry || !chatbotEntry) throw new Error("Veri hatası.");

const { contact } = siteEntry.data;
const { greeting, welcomeMessage, assistantName, options } = chatbotEntry.data;

const safeOptions = options || [];

const processTemplate = (text: string) => {
  return text
    .replace(/\{\{phone\}\}/g, contact.phone || '')
    .replace(/\{\{phoneLink\}\}/g, contact.phoneLink || '')
    .replace(/\{\{email\}\}/g, contact.email || '')
    .replace(/\{\{whatsapp\}\}/g, contact.whatsapp || '');
};

const processedOptions = safeOptions.map(opt => ({
  ...opt,
  botResponse: processTemplate(opt.botResponse),
  icon: opt.icon
}));

const iconPaths: Record<string, string> = {
  whatsapp:
    "M256 32C132.3 32 32 132.3 32 256c0 44.3 13 87.6 37.6 124.7L48 480l102.6-20.7C186 480.7 220.7 496 256 496c123.7 0 224-100.3 224-224S379.7 32 256 32zm0 416c-30.2 0-59.9-8.1-85.9-23.4l-6.2-3.7-60.9 12.3 12.8-59.1-4-6.5C88.1 340.5 80 298.6 80 256c0-97 79-176 176-176s176 79 176 176-79 176-176 176zm101.8-125.6c-5.6-2.8-33-16.3-38.1-18.1-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.4 18.1-17.7 21.8-3.3 3.7-6.5 4.2-12.1 1.4-5.6-2.8-23.6-8.7-45-27.7-16.7-14.8-27.9-33.2-31.2-38.8-3.3-5.6-.3-8.6 2.5-11.3 2.5-2.5 5.6-6.5 8.4-9.8 2.8-3.3 3.7-5.6 5.6-9.3 1.9-3.7.9-7-0.5-9.8-1.4-2.8-12.5-30.2-17.1-41.3-4.6-11-9.3-9.5-12.5-9.7-3-.1-6.5-.1-9.9-.1-3.5 0-9.3 1.3-14.1 6.5-4.8 5.2-18.5 18.1-18.5 44 0 25.9 19 50.9 21.7 54.6 2.7 3.7 37.2 56.6 90.2 79.4 31.5 13.6 37.6 10.9 51.2 10.1 13.6-.8 33-13.6 37.6-26.9 4.6-13.3 4.6-24.6 3.2-26.9-1.4-2.3-5.1-3.7-10.7-6.5z",

  robot:
    "M64 256a64 64 0 1 1 128 0 64 64 0 1 1-128 0zm256 0a64 64 0 1 1 128 0 64 64 0 1 1-128 0zM176 144c0-26.5 21.5-48 48-48h64c26.5 0 48 21.5 48 48v48h-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h16v32c0 26.5-21.5 48-48 48H224c-26.5 0-48-21.5-48-48V256h16c8.8 0 16-7.2 16-16V208c0-8.8-7.2-16-16-16h-16V144z",

  chevron_down:
    "M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z",

  xmark:
    "M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z",

  message:
    "M256 32C114.6 32 0 125.1 0 240c0 47.6 19.9 91.2 52.9 126.3C38 405.7 7 439.1 6.5 439.5c-6.6 7-8.4 17.2-4.6 26S14.4 480 24 480c61.5 0 110-25.7 139.1-46.3C192 442.8 223.2 448 256 448c141.4 0 256-93.1 256-208S397.4 32 256 32z",

  comments:
    "M64 64h256c35.3 0 64 28.7 64 64v128c0 35.3-28.7 64-64 64H192l-80 64v-64H64c-35.3 0-64-28.7-64-64V128c0-35.3 28.7-64 64-64zm320 128h64c35.3 0 64 28.7 64 64v96c0 35.3-28.7 64-64 64h-32v48l-64-48h-32c-6.9 0-13.5-1.1-19.7-3.1c19.1-17.8 31.1-43.1 31.1-71.3V192z",

  phone:
    "M164.9 24.6c-7.7-18.6-28-28.5-47.4-23.2l-88 24C12.1 30.2 0 46 0 64C0 311.4 200.6 512 448 512c18 0 33.8-12.1 38.6-29.5l24-88c5.3-19.4-4.6-39.7-23.2-47.4l-96-40c-16.3-6.8-35.2-2.1-46.3 11.6L304.7 368C234.3 334.7 177.3 277.7 144 207.3L193.3 167c13.7-11.2 18.4-30 11.6-46.3l-40-96z",

  calendar:
    "M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z",

  briefcase:
    "M128 480h256V80c0-26.5-21.5-48-48-48H176c-26.5 0-48 21.5-48 48v400zm64-400h128v32H192V80zM0 128C0 92.7 28.7 64 64 64h32v48H64c-8.8 0-16 7.2-16 16v32h416v-32c0-8.8-7.2-16-16-16h-32V64h32c35.3 0 64 28.7 64 64v320c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z",

  coins:
    "M0 405.3c0 50.5 108.8 91.5 243 91.5 134.2 0 243-41 243-91.5 0-24.1-24.9-46.4-66.9-63.5-36.8 28.6-94.8 47.5-161.4 47.5-66.6 0-124.6-18.9-161.4-47.5-42 17.1-66.9 39.4-66.9 63.5z",

  default:
    "M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512z"
};

const getIconPath = (iconClass: string) => {
  if (!iconClass) return iconPaths.default;
  if (iconClass.includes('whatsapp')) return iconPaths.whatsapp;
  if (iconClass.includes('phone')) return iconPaths.phone;
  if (iconClass.includes('calendar')) return iconPaths.calendar;
  if (iconClass.includes('comments')) return iconPaths.comments;
  if (iconClass.includes('message')) return iconPaths.message;
  if (iconClass.includes('briefcase')) return iconPaths.briefcase;
  if (iconClass.includes('coins')) return iconPaths.coins;
  return iconPaths.default;
};
---

<div id="super-fab-wrapper" class="super-fab-wrapper">
  <div id="fabGreeting" class="fab-greeting">
    {greeting}
    <button class="greeting-close" onclick="closeGreeting()" aria-label="Bildirimi Kapat">&times;</button>
  </div>

  <div id="chatWindow" class="chat-window" role="dialog" aria-hidden="true">
    <div class="chat-header">
      <div class="header-info">
        <span class="assistant-avatar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="20" height="20">
            <path d={iconPaths.robot}/>
          </svg>
        </span>
        <div>
          <span class="assistant-name">{assistantName}</span>
          <span class="status-text">Çevrimiçi</span>
        </div>
      </div>
      <button id="closeChatBtn" class="close-chat-btn" onclick="toggleChatWindow(false)" aria-label="Sohbeti Kapat">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="16" height="16">
          <path d={iconPaths.chevron_down}/>
        </svg>
      </button>
    </div>

    <div id="chatBody" class="chat-body">
      <div class="chat-msg bot" set:html={welcomeMessage}></div>
      <div class="chat-options">
        {processedOptions.map((opt) => (
          <button class="option-btn" data-reply={opt.key} data-user={opt.userText} data-bot={opt.botResponse} onclick="handleOptionClick(this)">
            {opt.icon && (
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="14" height="14" style="min-width:14px; margin-right: 5px;">
                <path d={getIconPath(opt.icon)}/>
              </svg>
            )}
            {opt.label}
          </button>
        ))}
      </div>
    </div>
  </div>

  <div id="fabMenu" class="fab-menu" aria-hidden="true">
    <a href={`https://wa.me/${contact.whatsapp}`} target="_blank" class="fab-item whatsapp" aria-label="WhatsApp ile Sohbet Et">
      <span class="fab-label">WhatsApp</span>
      <div class="fab-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="24" height="24">
          <path d={iconPaths.whatsapp}/>
        </svg>
      </div>
    </a>

    <button id="openAssistantBtn" class="fab-item assistant" onclick="openAssistant()" aria-label="Asistanı Başlat">
      <span class="fab-label">Asistan</span>
      <div class="fab-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="20" height="20">
          <path d={iconPaths.comments}/>
        </svg>
      </div>
    </button>

    <a href={contact.phoneLink} class="fab-item call" aria-label="Hemen Ara">
      <span class="fab-label">Hemen Ara</span>
      <div class="fab-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="20" height="20">
          <path d={iconPaths.phone}/>
        </svg>
      </div>
    </a>

    <a href="/iletisim" class="fab-item appointment" aria-label="Randevu Al">
      <span class="fab-label">Randevu Al</span>
      <div class="fab-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="20" height="20">
          <path d={iconPaths.calendar}/>
        </svg>
      </div>
    </a>
  </div>

  <button id="mainFabBtn" class="main-fab-btn" onclick="toggleFabMenu()" aria-label="İletişim Menüsünü Aç">
    <svg class="icon-default" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="24" height="24">
      <path d={iconPaths.message}/>
    </svg>
    <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="24" height="24">
      <path d={iconPaths.xmark}/>
    </svg>
  </button>
</div>

<style>
  .super-fab-wrapper { position: fixed; bottom: 25px; right: 25px; z-index: 9999; font-family: 'Montserrat', sans-serif; display: flex; flex-direction: column; align-items: flex-end; }
  .main-fab-btn { width: 60px; height: 60px; background-color: #002B5B; color: white; border-radius: 50%; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.3s; position: relative; z-index: 10002; }
  .main-fab-btn:hover { transform: scale(1.05); background-color: #003d82; }
  .main-fab-btn .icon-close { display: none; }
  .super-fab-wrapper.active .main-fab-btn { transform: rotate(90deg); background-color: #333; }
  .super-fab-wrapper.active .main-fab-btn .icon-default { display: none; }
  .super-fab-wrapper.active .main-fab-btn .icon-close { display: block; }
  .fab-greeting { position: absolute; bottom: 80px; right: 0; background: white; padding: 12px 20px; border-radius: 14px 14px 0 14px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); color: #333; font-size: 14px; font-weight: 500; white-space: nowrap; opacity: 0; visibility: hidden; transform: translateY(10px); transition: 0.3s; z-index: 10000; border: 1px solid #eee; }
  .fab-greeting.show { opacity: 1; visibility: visible; transform: translateY(0); }
  .greeting-close { position: absolute; top: -8px; right: -8px; background: #eee; color: #666; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .fab-menu { display: flex; flex-direction: column; gap: 12px; position: absolute; bottom: 80px; right: 0; pointer-events: none; }
  .super-fab-wrapper.active .fab-menu { pointer-events: auto; }
  .fab-item { display: flex; align-items: center; justify-content: flex-end; gap: 12px; text-decoration: none; border: none; background: none; cursor: pointer; opacity: 0; transform: translateY(20px) scale(0.8); transition: 0.3s; }
  .super-fab-wrapper.active .fab-item { opacity: 1; transform: translateY(0) scale(1); }
  .super-fab-wrapper.active .fab-item:nth-child(4) { transition-delay: 0.05s; }
  .super-fab-wrapper.active .fab-item:nth-child(3) { transition-delay: 0.1s; }
  .super-fab-wrapper.active .fab-item:nth-child(2) { transition-delay: 0.15s; }
  .super-fab-wrapper.active .fab-item:nth-child(1) { transition-delay: 0.2s; }
  .fab-label { background: white; padding: 6px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; color: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .fab-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
  .fab-item:hover .fab-icon { transform: scale(1.1); }
  .whatsapp .fab-icon { background-color: #25D366; }
  .assistant .fab-icon { background-color: #002B5B; }
  .call .fab-icon { background-color: #007bff; }
  .appointment .fab-icon { background-color: #e67e22; }
  .chat-window { position: fixed; bottom: 90px; right: 25px; width: 350px; height: 500px; max-height: 70vh; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; z-index: 10001; opacity: 0; visibility: hidden; transform: translateY(20px) scale(0.95); transition: 0.3s; border: 1px solid #eee; }
  .chat-window.open { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
  .chat-header { background: #002B5B; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
  .header-info { display: flex; align-items: center; gap: 10px; }
  .assistant-avatar { background: rgba(255,255,255,0.2); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .assistant-name { font-weight: 700; display: block; font-size: 14px; }
  .status-text { font-size: 11px; opacity: 0.8; }
  .close-chat-btn { background: none; border: none; color: white; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
  .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
  .chat-msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; position: relative; word-wrap: break-word; }
  .chat-msg.bot { background: white; color: #333; border-bottom-left-radius: 2px; border: 1px solid #e5e5e5; align-self: flex-start; }
  .chat-msg.user { background: #002B5B; color: white; border-bottom-right-radius: 2px; align-self: flex-end; }
  .chat-options { display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
  .chat-options button { background: white; border: 1px solid #002B5B; color: #002B5B; padding: 10px; border-radius: 10px; font-size: 13px; cursor: pointer; text-align: left; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
  .chat-options button:hover { background: #002B5B; color: white; }
  .chat-options button svg { width: 16px; height: 16px; }
  @media (max-width: 768px) {
    .super-fab-wrapper { bottom: 20px; right: 20px; }
    .chat-window { bottom: 0; right: 0; left: 0; width: 100%; height: 100%; max-height: 100%; border-radius: 0; z-index: 20000; }
    .chat-header { padding-top: env(safe-area-inset-top); height: 70px; }
    .close-chat-btn { font-size: 20px; padding: 10px; }
  }
</style>

<script is:inline>
  window.toggleFabMenu = function() {
    const wrapper = document.getElementById('super-fab-wrapper');
    const chatWindow = document.getElementById('chatWindow');
    const greeting = document.getElementById('fabGreeting');

    if (chatWindow && chatWindow.classList.contains('open')) {
      chatWindow.classList.remove('open');
      wrapper.classList.remove('active');
    } else {
      wrapper.classList.toggle('active');
      if (greeting) greeting.classList.remove('show');
    }
  };

  window.openAssistant = function() {
    const wrapper = document.getElementById('super-fab-wrapper');
    const chatWindow = document.getElementById('chatWindow');
    if (wrapper) wrapper.classList.remove('active');
    if (chatWindow) chatWindow.classList.add('open');
  };

  window.toggleChatWindow = function(shouldOpen) {
    const chatWindow = document.getElementById('chatWindow');
    if (!chatWindow) return;
    if (shouldOpen) chatWindow.classList.add('open');
    else chatWindow.classList.remove('open');
  };

  window.closeGreeting = function() {
    const greeting = document.getElementById('fabGreeting');
    if (greeting) greeting.classList.remove('show');
  };

  window.handleOptionClick = function(btn) {
    const userText = btn.getAttribute('data-user');
    const botText = btn.getAttribute('data-bot');
    const chatBody = document.getElementById('chatBody');
    const optionsDiv = chatBody.querySelector('.chat-options');

    const userDiv = document.createElement('div');
    userDiv.className = 'chat-msg user';
    userDiv.innerHTML = userText;
    chatBody.insertBefore(userDiv, optionsDiv);

    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = '<span></span><span></span><span></span>';
    chatBody.insertBefore(typingDiv, optionsDiv);
    chatBody.scrollTop = chatBody.scrollHeight;

    setTimeout(function() {
      typingDiv.remove();
      const botDiv = document.createElement('div');
      botDiv.className = 'chat-msg bot';
      botDiv.innerHTML = botText;
      chatBody.insertBefore(botDiv, optionsDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }, 800);
  };

  document.addEventListener('DOMContentLoaded', () => {
    const greeting = document.getElementById('fabGreeting');
    if (greeting && !localStorage.getItem('fabGreetingShown')) {
      setTimeout(() => {
        greeting.classList.add('show');
        localStorage.setItem('fabGreetingShown', 'true');
      }, 3000);
      setTimeout(() => greeting.classList.remove('show'), 13000);
    }
  });
</script>