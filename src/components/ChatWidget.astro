---
// Chat Widget & Unified Communication FAB
// %100 Inline SVG - CDN Bağımlılığı Yok
import { getEntry } from 'astro:content';

const siteEntry = await getEntry('site', 'main');
const chatbotEntry = await getEntry('chatbot', 'main');

if (!siteEntry || !chatbotEntry) {
  throw new Error("Site veya Chatbot verisi bulunamadı.");
}

const { contact } = siteEntry.data;
const { greeting, welcomeMessage, assistantName, options } = chatbotEntry.data;

const safeOptions = options || [];

const processTemplate = (text: string) => {
  return text
    .replace(/\{\{phone\}\}/g, contact.phone || '')
    .replace(/\{\{phoneLink\}\}/g, contact.phoneLink || '')
    .replace(/\{\{email\}\}/g, contact.email || '')
    .replace(/\{\{whatsapp\}\}/g, contact.whatsapp || '');
};

const processedOptions = safeOptions.map(opt => ({
  ...opt,
  botResponse: processTemplate(opt.botResponse)
}));

// SVG Path Kütüphanesi (Common Icons)
const iconPaths: Record<string, string> = {
  // Brands
  whatsapp: "M414.7 71.6C374.3 31.2 320.5 9 264.4 9 146.5 9 50.6 105 50.6 222.9 50.6 260.6 60.5 296.2 78.4 327.9L49 435l110.1-28.9c31 16.9 66 25.8 105.3 25.8h.1c117.9 0 213.9-96 213.9-213.9 0-57.1-22.3-110.9-63.7-156.4zM264.4 402.6c-35.8 0-70.9-9.6-101.9-28l-7.3-4.3-75.7 19.9 20.2-73.8-4.7-7.6c-20-31.9-30.6-69.2-30.6-108.3 0-111.9 91.1-203 203.1-203 54.3 0 105.3 21.1 143.7 59.5s59.5 89.4 59.5 143.7c-.1 112-91.2 202.9-203.3 202.9zm111.5-151.7c-6.1-3.1-36.2-17.9-41.8-19.9-5.6-2.1-9.7-3.1-13.8 3.1-4.1 6.2-16 19.9-19.6 24-3.6 4.1-7.2 4.6-13.3 1.5-6.1-3.1-25.7-9.5-49-30.2-18.1-16.1-30.3-36.1-33.8-42.2-3.6-6.1-.4-9.4 2.7-12.4 2.7-2.7 6.1-7.2 9.1-10.7 3.1-3.6 4.1-6.1 6.1-10.1 2.1-4.1 1-7.6-.5-10.7-1.5-3.1-13.8-33.3-18.9-45.6-5.1-12.1-10.3-10.5-13.8-10.7-3.3-.2-7.1-.2-10.9-.2-3.8 0-10 1.4-15.2 7.1-5.2 5.7-20 19.5-20 47.6 0 28.1 20.4 55.3 23.3 59.3 2.9 4.1 40.2 61.3 97.4 86 33.9 14.6 40.6 11.7 55.4 10.9 14.8-.8 36.2-14.8 41.3-29.1 5.1-14.3 5.1-26.6 3.6-29.1-1.5-2.5-5.6-4.1-11.7-7.2z",
  
  // UI Elements
  robot: "M32 224H48c0-53 43-96 96-96h32c0-35.3 28.7-64 64-64h32c35.3 0 64 28.7 64 64h32c53 0 96 43 96 96h16c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32H464v64c0 35.3-28.7 64-64 64H112c-35.3 0-64-28.7-64-64V384H32c-17.7 0-32-14.3-32-32V256c0-17.7 14.3-32 32-32zM240 208a32 32 0 1 0 0 64 32 32 0 1 0 0-64zm104 32a32 32 0 1 0 64 0 32 32 0 1 0 -64 0z",
  chevron_down: "M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z",
  xmark: "M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z",
  message: "M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0z",
  comments: "M208 352c-2.3 23-4 46.1-6.9 67.3-5.3 39-54.2 71.4-95.2 62.5-11.3-2.5-22.9 8.9-30.8 16.5-23.7 22.7-72 31.1-72 31.1s13.3-64.8 5.7-105.7c-2.5-13.6-1.5-26.9 3.5-39.2-2.3 2.8-5 5.2-8.3 7-23.9 12.8-40 37.8-40 66.5 0 32.9 21.6 61.1 52.4 70.3 33.5 10 44.2 26.7 54.1 49.3 11 25.1 36.3 40.8 63.8 40.8 19.3 0 37.7-7.8 51.5-20.4 8.2-7.5 20.3-13.7 32-11.2 42.4 9.2 92.2-24.1 97.6-64.5 3-21.9 4.7-45.7 7-69.5-39.7 13.5-79.6 13.5-114.4-.3z M448 64c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V80c0-8.8-7.2-16-16-16h-32zm0-64H128C57.3 0 0 57.3 0 128v192c0 70.7 57.3 128 128 128h320c70.7 0 128-57.3 128-128V128c0-70.7-57.3-128-128-128z",
  
  // Actions
  phone: "M164.9 24.6c-7.7-18.6-28-28.5-47.4-23.2l-88 24C12.1 30.2 0 46 0 64C0 311.4 200.6 512 448 512c18 0 33.8-12.1 38.6-29.5l24-88c5.3-19.4-4.6-39.7-23.2-47.4l-96-40c-16.3-6.8-35.2-2.1-46.3 11.6L304.7 368C234.3 334.7 177.3 277.7 144 207.3L193.3 167c13.7-11.2 18.4-30 11.6-46.3l-40-96z",
  calendar: "M128 0c17.7 0 32 14.3 32 32V64H288V32c0-17.7 14.3-32 32-32s32 14.3 32 32V64h48c26.5 0 48 21.5 48 48v48H0V112C0 85.5 21.5 64 48 64H96V32c0-17.7 14.3-32 32-32zM0 192H448V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V192zm336 136a24 24 0 1 0 -48 0 24 24 0 1 0 48 0z",
  
  // Default Fallback
  default: "M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"
};

// Akıllı İkon Eşleştirici (Chatbot JSON'dan gelen 'fa-solid' sınıflarını SVG'ye çevirir)
const getIconPath = (iconClass: string) => {
  if (!iconClass) return iconPaths.default;
  if (iconClass.includes('whatsapp')) return iconPaths.whatsapp;
  if (iconClass.includes('phone')) return iconPaths.phone;
  if (iconClass.includes('calendar')) return iconPaths.calendar;
  if (iconClass.includes('comments')) return iconPaths.comments;
  if (iconClass.includes('message')) return iconPaths.message;
  // Fallback
  return iconPaths.default;
};
---

<div id="super-fab-wrapper" class="super-fab-wrapper">
  
  <div id="fabGreeting" class="fab-greeting">
    {greeting}
    <button class="greeting-close" aria-label="Kapat">&times;</button>
  </div>

  <div id="chatWindow" class="chat-window" role="dialog" aria-hidden="true">
    <div class="chat-header">
      <div class="header-info">
        <span class="assistant-avatar">
          <svg viewBox="0 0 512 512" width="20" height="20" fill="currentColor"><path d={iconPaths.robot}/></svg>
        </span>
        <div>
          <span class="assistant-name">{assistantName}</span>
          <span class="status-text">Çevrimiçi</span>
        </div>
      </div>
      <button id="closeChatBtn" class="close-chat-btn" aria-label="Sohbeti kapat">
        <svg viewBox="0 0 512 512" width="16" height="16" fill="currentColor"><path d={iconPaths.chevron_down}/></svg>
      </button>
    </div>
    
    <div id="chatBody" class="chat-body">
      <div class="chat-msg bot">{welcomeMessage}</div>
      <div class="chat-options">
        {processedOptions.map((opt) => (
          <button data-reply={opt.key} data-user={opt.userText} data-bot={opt.botResponse}>
            {opt.icon && (
              <svg viewBox="0 0 512 512" width="14" height="14" fill="currentColor" style="min-width:14px">
                <path d={getIconPath(opt.icon)} />
              </svg>
            )}
            {opt.label}
          </button>
        ))}
      </div>
    </div>
  </div>

  <div id="fabMenu" class="fab-menu" aria-hidden="true">
    
    <a href={`https://wa.me/${contact.whatsapp}`} target="_blank" rel="noopener noreferrer" class="fab-item whatsapp" aria-label="WhatsApp">
      <span class="fab-label">WhatsApp</span>
      <div class="fab-icon">
        <svg viewBox="0 0 448 512" width="24" height="24" fill="currentColor"><path d={iconPaths.whatsapp}/></svg>
      </div>
    </a>

    <button id="openAssistantBtn" class="fab-item assistant" aria-label="Asistan">
      <span class="fab-label">Asistan</span>
      <div class="fab-icon">
        <svg viewBox="0 0 512 512" width="20" height="20" fill="currentColor"><path d={iconPaths.comments}/></svg>
      </div>
    </button>

    <a href={contact.phoneLink} class="fab-item call" aria-label="Hemen Ara">
      <span class="fab-label">Hemen Ara</span>
      <div class="fab-icon">
        <svg viewBox="0 0 512 512" width="20" height="20" fill="currentColor"><path d={iconPaths.phone}/></svg>
      </div>
    </a>

    <a href="/iletisim" class="fab-item appointment" aria-label="Randevu Al">
      <span class="fab-label">Randevu Al</span>
      <div class="fab-icon">
        <svg viewBox="0 0 448 512" width="20" height="20" fill="currentColor"><path d={iconPaths.calendar}/></svg>
      </div>
    </a>

  </div>

  <button id="mainFabBtn" class="main-fab-btn" aria-label="İletişim Seçenekleri">
    <svg class="icon-default" viewBox="0 0 512 512" width="24" height="24" fill="currentColor"><path d={iconPaths.message}/></svg>
    <svg class="icon-close" viewBox="0 0 384 512" width="24" height="24" fill="currentColor"><path d={iconPaths.xmark}/></svg>
  </button>

</div>

<style>
  /* --- WRAPPER & POSITIONING --- */
  .super-fab-wrapper {
    position: fixed;
    bottom: 25px;
    right: 25px;
    z-index: 9999;
    font-family: 'Montserrat', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

  /* --- MAIN BUTTON --- */
  .main-fab-btn {
    width: 60px;
    height: 60px;
    background-color: #002B5B;
    color: white;
    border-radius: 50%;
    border: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    z-index: 10002;
  }
  
  .main-fab-btn:hover { transform: scale(1.05); background-color: #003d82; }
  .main-fab-btn .icon-close { display: none; }
  .super-fab-wrapper.active .main-fab-btn { transform: rotate(90deg); background-color: #333; }
  .super-fab-wrapper.active .main-fab-btn .icon-default { display: none; }
  .super-fab-wrapper.active .main-fab-btn .icon-close { display: block; }

  /* --- GREETING BUBBLE --- */
  .fab-greeting {
    position: absolute;
    bottom: 80px;
    right: 0;
    background: white;
    padding: 12px 20px;
    border-radius: 14px 14px 0 14px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    color: #333;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
    z-index: 10000;
    border: 1px solid #eee;
  }
  
  .fab-greeting.show { opacity: 1; visibility: visible; transform: translateY(0); }

  .greeting-close {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #eee;
    color: #666;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* --- FAB MENU ITEMS --- */
  .fab-menu {
    display: flex;
    flex-direction: column;
    gap: 12px;
    position: absolute;
    bottom: 80px;
    right: 0;
    pointer-events: none;
  }

  .super-fab-wrapper.active .fab-menu { pointer-events: auto; }

  .fab-item {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    text-decoration: none;
    border: none;
    background: none;
    cursor: pointer;
    opacity: 0;
    transform: translateY(20px) scale(0.8);
    transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
  }

  .super-fab-wrapper.active .fab-item { opacity: 1; transform: translateY(0) scale(1); }
  .super-fab-wrapper.active .fab-item:nth-child(4) { transition-delay: 0.05s; }
  .super-fab-wrapper.active .fab-item:nth-child(3) { transition-delay: 0.1s; }
  .super-fab-wrapper.active .fab-item:nth-child(2) { transition-delay: 0.15s; }
  .super-fab-wrapper.active .fab-item:nth-child(1) { transition-delay: 0.2s; }

  .fab-label {
    background: white;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    color: #333;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .fab-icon {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s;
  }

  .fab-item:hover .fab-icon { transform: scale(1.1); }

  .whatsapp .fab-icon { background-color: #25D366; }
  .assistant .fab-icon { background-color: #002B5B; }
  .call .fab-icon { background-color: #007bff; }
  .appointment .fab-icon { background-color: #e67e22; }

  /* --- CHAT WINDOW --- */
  .chat-window {
    position: fixed;
    bottom: 90px;
    right: 25px;
    width: 350px;
    height: 500px;
    max-height: 70vh;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 10001;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s ease;
    border: 1px solid #eee;
  }

  .chat-window.open { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }

  .chat-header {
    background: #002B5B;
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header-info { display: flex; align-items: center; gap: 10px; }
  .assistant-avatar { background: rgba(255,255,255,0.2); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .assistant-name { font-weight: 700; display: block; font-size: 14px; }
  .status-text { font-size: 11px; opacity: 0.8; }
  .close-chat-btn { background: none; border: none; color: white; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }

  .chat-body {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .chat-msg {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
    position: relative;
    word-wrap: break-word;
  }
  .chat-msg.bot { background: white; color: #333; border-bottom-left-radius: 2px; border: 1px solid #e5e5e5; align-self: flex-start; }
  .chat-msg.user { background: #002B5B; color: white; border-bottom-right-radius: 2px; align-self: flex-end; }

  .chat-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 5px;
  }
  .chat-options button {
    background: white;
    border: 1px solid #002B5B;
    color: #002B5B;
    padding: 10px;
    border-radius: 10px;
    font-size: 13px;
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chat-options button:hover { background: #002B5B; color: white; }

  .typing-indicator span { display: inline-block; width: 6px; height: 6px; background: #ccc; border-radius: 50%; margin: 0 2px; animation: typing 1s infinite; }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

  @media (max-width: 768px) {
    .super-fab-wrapper { bottom: 20px; right: 20px; }
    .chat-window { bottom: 0; right: 0; left: 0; width: 100%; height: 100%; max-height: 100%; border-radius: 0; z-index: 20000; }
    .chat-header { padding-top: env(safe-area-inset-top); height: 70px; }
    .close-chat-btn { font-size: 20px; padding: 10px; }
  }
</style>

<script>
  function initSuperFab() {
    const wrapper = document.getElementById('super-fab-wrapper');
    const mainBtn = document.getElementById('mainFabBtn');
    const greeting = document.getElementById('fabGreeting');
    const closeGreeting = document.querySelector('.greeting-close');
    
    const openAssistantBtn = document.getElementById('openAssistantBtn');
    const chatWindow = document.getElementById('chatWindow');
    const closeChatBtn = document.getElementById('closeChatBtn');
    const chatBody = document.getElementById('chatBody');

    if (!wrapper || !mainBtn || !chatWindow) return;

    let hasSeenGreeting = localStorage.getItem('fabGreetingShown');
    if (!hasSeenGreeting && greeting) {
      setTimeout(() => {
        greeting.classList.add('show');
        localStorage.setItem('fabGreetingShown', 'true');
      }, 3000);
      setTimeout(() => greeting.classList.remove('show'), 13000);
    }
    
    if (closeGreeting && greeting) {
      closeGreeting.addEventListener('click', () => greeting.classList.remove('show'));
    }

    mainBtn.addEventListener('click', () => {
      if (chatWindow.classList.contains('open')) {
        chatWindow.classList.remove('open');
        wrapper.classList.remove('active');
      } else {
        wrapper.classList.toggle('active');
        if (greeting) greeting.classList.remove('show');
      }
    });

    if (openAssistantBtn) {
      openAssistantBtn.addEventListener('click', () => {
        wrapper.classList.remove('active');
        chatWindow.classList.add('open');
      });
    }

    if (closeChatBtn) {
      closeChatBtn.addEventListener('click', () => {
        chatWindow.classList.remove('open');
      });
    }

    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!wrapper.contains(target) && wrapper.classList.contains('active')) {
        wrapper.classList.remove('active');
      }
    });

    if (chatBody) {
      const buttons = chatBody.querySelectorAll('.chat-options button');
      buttons.forEach((btn) => {
        const newBtn = btn.cloneNode(true) as HTMLButtonElement;
        btn.parentNode?.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', function(e) {
          const target = e.currentTarget as HTMLButtonElement;
          const userText = target.getAttribute('data-user');
          const botText = target.getAttribute('data-bot');
          
          if (!userText || !botText) return;

          const options = chatBody.querySelector('.chat-options');

          const userDiv = document.createElement('div');
          userDiv.className = 'chat-msg user';
          userDiv.innerHTML = userText;
          if (options) chatBody.insertBefore(userDiv, options);

          const typingDiv = document.createElement('div');
          typingDiv.className = 'typing-indicator';
          typingDiv.innerHTML = '<span></span><span></span><span></span>';
          if (options) chatBody.insertBefore(typingDiv, options);
          chatBody.scrollTop = chatBody.scrollHeight;

          setTimeout(function() {
            typingDiv.remove();
            const botDiv = document.createElement('div');
            botDiv.className = 'chat-msg bot';
            botDiv.innerHTML = botText;
            if (options) chatBody.insertBefore(botDiv, options);
            chatBody.scrollTop = chatBody.scrollHeight;
          }, 800);
        });
      });
    }
  }

  document.addEventListener('DOMContentLoaded', initSuperFab);
  document.addEventListener('astro:after-swap', initSuperFab);
</script>