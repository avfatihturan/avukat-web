---
import { getCollection, getEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Hero from '../../components/Hero.astro';
import ArticleCard from '../../components/ArticleCard.astro';

const siteEntry = await getEntry('site', 'main');

if (!siteEntry) {
  throw new Error("Site verisi bulunamadı.");
}

const { name } = siteEntry.data;
const allArticles = await getCollection('articles', ({ data }) => !data.draft);
const sortedArticles = allArticles.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 1. Etiketleri Topla (TS Düzeltmesi: ': t is string' eklendi)
const allTags = [
  ...new Set(allArticles.map((article) => article.data.tag).filter((t): t is string => !!t))
].sort();

// 2. Hangi etiketten kaç tane var hesapla (TS Düzeltmesi: 'acc: Record<string, number>' eklendi)
const tagCounts = allArticles.reduce((acc: Record<string, number>, article) => {
  const tag = article.data.tag;
  if (tag) {
    acc[tag] = (acc[tag] || 0) + 1;
  }
  return acc;
}, {});
---

<BaseLayout
  title={`Yayınlar ve Makaleler | ${name}`}
  description="Hukuki makaleler, yargıtay kararları ve güncel mevzuat değerlendirmeleri."
  currentPage="yayinlar"
  canonicalUrl="/yayinlar"
>
  <Hero 
    title="Hukuki Yayınlar ve Makaleler" 
    size="sm"
    image="/images/banner-blog.webp"
  />

  <section class="page-section">
    <div class="container">
      
      <div class="filter-container">
        <button class="filter-btn active" data-filter="all">
          Tümü ({sortedArticles.length})
        </button>
        
        {allTags.map((tag) => (
          <button class="filter-btn" data-filter={tag}>
            {tag} ({tagCounts[tag] || 0})
          </button>
        ))}
      </div>

      <div class="grid-3" id="article-grid">
        {sortedArticles.map((article) => (
          <div class="article-item" data-tag={article.data.tag || ''}>
            <ArticleCard
              title={article.data.title}
              description={article.data.description}
              href={`/yayinlar/${article.id}`} 
              image={article.data.heroImage}
              tag={article.data.tag || ''} 
            />
          </div>
        ))}
      </div>

      <div id="no-results" style="display: none; text-align: center; padding: 40px; color: var(--color-text-secondary);">
        <p>Seçilen kategoride henüz bir yayın bulunmamaktadır.</p>
      </div>

    </div>
  </section>
</BaseLayout>

<script>
  const filterBtns = document.querySelectorAll('.filter-btn');
  const articles = document.querySelectorAll('.article-item');
  const noResults = document.getElementById('no-results');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const filterValue = btn.getAttribute('data-filter');
      let hasVisibleArticles = false;

      articles.forEach(article => {
        const articleTag = article.getAttribute('data-tag');
        
        if (filterValue === 'all' || filterValue === articleTag) {
          (article as HTMLElement).style.display = 'block';
          hasVisibleArticles = true;
        } else {
          (article as HTMLElement).style.display = 'none';
        }
      });

      if (noResults) {
        noResults.style.display = hasVisibleArticles ? 'none' : 'block';
      }
    });
  });
</script>

<style>
  .page-section { padding: 4rem 0; background-color: var(--color-bg); min-height: 60vh; }
  
  .filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 40px;
  }

  .filter-btn {
    padding: 10px 20px;
    border: 1px solid var(--color-border);
    background-color: var(--card-bg);
    color: var(--color-text-secondary);
    border-radius: 30px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .filter-btn:hover {
    border-color: var(--brand-accent);
    color: var(--brand-primary);
  }

  .filter-btn.active {
    background-color: var(--brand-primary);
    color: #fff;
    border-color: var(--brand-primary);
  }
  
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; }
  
  @media (max-width: 1024px) { .grid-3 { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px) { .grid-3 { grid-template-columns: 1fr; } }
</style>